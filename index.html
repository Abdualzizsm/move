<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>قرية الأفلام - مشاهدة مجانية</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
            line-height: 1.6;
        }

        .header {
            background: rgba(0, 0, 0, 0.9);
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #e50914;
        }

        .search-container {
            position: relative;
            max-width: 500px;
            width: 100%;
            margin: 0 2rem;
        }

        .search-input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.3);
        }

        .search-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #e50914;
            font-size: 18px;
            cursor: pointer;
        }

        .main-content {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-section {
            text-align: center;
            padding: 4rem 0;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MDAiIHZpZXdCb3g9IjAgMCAxMjAwIDYwMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjEyMDAiIGhlaWdodD0iNjAwIiBmaWxsPSIjMTExIi8+Cjx0ZXh0IHg9IjYwMCIgeT0iMzAwIiBmaWxsPSIjMzMzIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Qm9sbHl3b29kIE1vdmllczwvdGV4dD4KPHN2Zz4K');
            background-size: cover;
            border-radius: 15px;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #e50914;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: #cccccc;
            margin-bottom: 2rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 10px 20px;
            background: rgba(229, 9, 20, 0.2);
            border: 2px solid #e50914;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #e50914;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 9, 20, 0.4);
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            padding: 0 1rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .movie-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .movie-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: #e50914;
        }

        .movie-poster {
            width: 100%;
            height: 350px;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .movie-card:hover .movie-poster {
            transform: scale(1.05);
        }

        .movie-info {
            padding: 1.5rem;
        }

        .movie-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .movie-year {
            color: #e50914;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .movie-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .stars {
            color: #ffd700;
        }

        .movie-overview {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .watch-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #e50914, #ff6b6b);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .watch-btn:hover {
            background: linear-gradient(45deg, #ff6b6b, #e50914);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 9, 20, 0.4);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #e50914;
        }

        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Movie Player Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 0.5% auto;
            padding: 0;
            border-radius: 15px;
            width: 99%;
            max-width: 1800px;
            max-height: 99vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #ffffff;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            background: rgba(0, 0, 0, 0.7);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close:hover {
            background: #e50914;
            transform: scale(1.1);
        }

        .modal-header {
            padding: 30px 30px 0;
            text-align: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #e50914;
        }

        .video-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: rgba(229, 9, 20, 0.2);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab-btn.active {
            background: #e50914;
        }

        .video-container {
            width: 100%;
            height: 800px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .video-iframe {
            width: 100%;
            height: 100%;
            border: none;
            /* توافق أفضل مع iPhone ومنع الإعلانات */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            /* حماية إضافية */
            pointer-events: auto;
            touch-action: manipulation;
            /* ملء كامل للمساحة */
            object-fit: cover;
            min-height: 100%;
            min-width: 100%;
        }

        .movie-details {
            padding: 0 40px 40px;
        }

        .movie-meta {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .movie-poster-modal {
            width: 200px;
            border-radius: 10px;
        }

        .movie-info-modal {
            flex: 1;
            margin-left: 20px;
        }

        .movie-title-modal {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #e50914;
        }

        .movie-rating-modal {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .movie-overview-modal {
            line-height: 1.6;
            color: #cccccc;
            margin-bottom: 20px;
        }

        .streaming-sources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .source-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .source-card:hover {
            border-color: #e50914;
            background: rgba(229, 9, 20, 0.1);
        }

        .source-link {
            display: block;
            color: #e50914;
            text-decoration: none;
            font-weight: bold;
            margin-top: 10px;
        }

        .source-description {
            color: #cccccc;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 3rem 0;
        }

        .page-btn {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover, .page-btn.active {
            background: #e50914;
            border-color: #e50914;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .favorites-btn {
            background: none;
            border: none;
            color: #e50914;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorites-btn:hover {
            transform: scale(1.2);
        }

        .favorites-btn.active {
            color: #ff6b6b;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 25px;
            background: #e50914;
            color: white;
            border-radius: 5px;
            z-index: 3000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.success {
            background: #28a745;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .search-container {
                margin: 0;
                max-width: 100%;
            }

            .hero-title {
                font-size: 2rem;
            }

        /* شاشات كبيرة جداً */
        @media (min-width: 1400px) {
            .modal-content {
                width: 95%;
                max-width: 2000px;
            }
            
            .video-container {
                height: 900px;
            }
            
            .movie-details {
                padding: 0 60px 60px;
            }
        }

        /* شاشات متوسطة */
        @media (min-width: 1024px) and (max-width: 1399px) {
            .video-container {
                height: 600px;
            }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .search-container {
                margin: 0;
                max-width: 100%;
            }

            .hero-title {
                font-size: 2rem;
            }

            .movies-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 0 10px;
            }
            
            .movie-card {
                height: 280px;
                margin-bottom: 10px;
            }
            
            .movie-poster {
                height: 200px;
            }
            
            .movie-title {
                font-size: 0.85rem;
                line-height: 1.2;
                padding: 8px;
            }
            
            .modal-content {
                width: 98%;
                margin: 1% auto;
                max-height: 98vh;
                overflow-y: auto;
            }
            
            .video-container {
                height: 350px;
                margin: 10px 0;
            }
            
            .video-tabs {
                flex-wrap: wrap;
                gap: 3px;
                margin-bottom: 10px;
            }
            
            .tab-btn {
                padding: 8px 10px;
                font-size: 0.75rem;
                flex: 1;
                min-width: 60px;
                margin: 2px;
            }
            
            .user-guide {
                font-size: 0.7rem !important;
                padding: 6px !important;
                margin: 6px 0 !important;
            }

            .movie-details {
                padding: 0 15px 15px;
            }
            
            .movie-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .movie-poster-modal {
                width: 120px !important;
                height: 180px !important;
            }
            
            .movie-info h3 {
                font-size: 1.1rem;
            }
            
            .movie-info p {
                font-size: 0.8rem;
                line-height: 1.3;
            }
            
            .close {
                top: 10px;
                right: 15px;
                font-size: 1.5rem;
            }
        }

            .movie-meta {
                flex-direction: column;
                gap: 0.5rem;
            }

            .movie-poster-modal {
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }

            .movie-info-modal {
                margin-left: 0;
                margin-top: 20px;
            }
        }

        .error-message {
            text-align: center;
            color: #e50914;
            padding: 2rem;
            font-size: 1.1rem;
        }

        .retry-btn {
            background: #e50914;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .no-results {
            text-align: center;
            color: #cccccc;
            padding: 3rem;
            font-size: 1.2rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #e50914;
            animation: spin 1s ease-in-out infinite;
        }

        .video-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #111;
            color: #ccc;
            flex-direction: column;
            gap: 15px;
        }

        .alternative-sources {
            margin-top: 20px;
        }

        .alternative-sources h4 {
            color: #e50914;
            margin-bottom: 15px;
        }

        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .source-btn {
            padding: 10px 15px;
            background: rgba(229, 9, 20, 0.2);
            border: 1px solid #e50914;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .source-btn:hover {
            background: #e50914;
        }

        .footer {
            text-align: center;
            padding: 3rem 2rem;
            background: rgba(0, 0, 0, 0.8);
            margin-top: 4rem;
        }

        .footer p {
            color: #666;
            font-size: 12px;
            text-align: center;
        }

        /* Ad Block Protection */
        .video-iframe {
            pointer-events: auto;
            border: none;
            background: #000;
        }

        .iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 10;
            pointer-events: none;
        }

        .ad-block-notice {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(229, 9, 20, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 20;
        }

        .clean-source {
            border: 2px solid #28a745 !important;
        }

        .clean-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            z-index: 15;
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">
                <i class="fas fa-film"></i> قرية الأفلام
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ابحث عن الأفلام...">
                <button class="search-btn" onclick="searchMovies()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div>
                <button class="favorites-btn" onclick="toggleFavorites()" title="المفضلة">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <section class="hero-section">
            <h1 class="hero-title">مرحباً بك في عالم السينما</h1>
            <p class="hero-subtitle">شاهد آلاف الأفلام مجاناً بجودة عالية</p>
        </section>

        <section class="filters">
            <button class="filter-btn active" onclick="filterMovies('all')">الكل</button>
            <button class="filter-btn" onclick="filterMovies('action')">أكشن</button>
            <button class="filter-btn" onclick="filterMovies('comedy')">كوميديا</button>
            <button class="filter-btn" onclick="filterMovies('drama')">دراما</button>
            <button class="filter-btn" onclick="filterMovies('horror')">رعب</button>
            <button class="filter-btn" onclick="filterMovies('romance')">رومانسي</button>
            <button class="filter-btn" onclick="filterMovies('sci-fi')">خيال علمي</button>
        </section>

        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
            جاري تحميل الأفلام...
        </div>

        <div class="movies-grid" id="moviesGrid"></div>

        <div class="pagination" id="pagination"></div>
    </main>

    <!-- Movie Modal -->
    <div id="movieModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle">عنوان الفيلم</h2>
            </div>
            
            <div class="movie-details">
                <div class="video-tabs">
                    <button class="tab-btn active" onclick="switchVideoTab('trailer')">تريلر</button>
                    <button class="tab-btn" onclick="switchVideoTab('movie')">مشاهدة الفيلم</button>
                    <button class="tab-btn" onclick="switchVideoTab('sources')">مصادر أخرى</button>
                    <button class="tab-btn" onclick="toggleAdBlock()" id="adBlockBtn" style="background: #28a745;">
                        <i class="fas fa-shield-alt"></i> الحماية
                    </button>
                </div>
                
                <div class="video-container" id="videoContainer">
                    <div class="video-error">
                        <i class="fas fa-play-circle" style="font-size: 4rem; margin-bottom: 20px;"></i>
                        <h3>اختر نوع المحتوى من الأعلى</h3>
                        <p>للحصول على أفضل تجربة مشاهدة، اختر "مشاهدة الفيلم"</p>
                    </div>
                </div>

                    <div class="user-guide" style="background: #1a1a1a; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #28a745;">
                        <div style="font-size: 0.85rem; line-height: 1.4; color: #ccc;">
                            <strong style="color: #28a745;">نصائح للمشاهدة:</strong> نقرة واحدة فقط - إذا لم يعمل مصدر جرب الآخر - يمكن تعطيل الحماية عند الحاجة
                        </div>
                    </div>
                    <img id="modalPoster" class="movie-poster-modal" src="" alt="">
                    <div class="movie-info-modal">
                        <div class="movie-rating-modal">
                            <div class="stars" id="modalStars"></div>
                            <span id="modalRating">0</span>
                        </div>
                        <p id="modalOverview" class="movie-overview-modal"></p>
                        
                        <div class="alternative-sources" id="alternativeSources" style="display: none;">
                            <h4>مصادر مباشرة للمشاهدة:</h4>
                            <div class="sources-grid" id="sourcesGrid"></div>
                        </div>
                    </div>
                </div>

                <div class="streaming-sources" id="streamingSources"></div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <footer class="footer">
        <p>&copy; 2024 قرية الأفلام - جميع الأفلام من مصادر مجانية وقانونية</p>
    </footer>

    <script>
        const API_KEY = 'b009eaecd7a27750722cc9e29ac50caf';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';

        let currentPage = 1;
        let currentGenre = 'all';
        let currentSearchQuery = '';
        let showingFavorites = false;

        // Load movies when page loads with ultimate protection
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🛡️ بدء تطبيق الحماية المطلقة للموقع...');
            
            // حماية فورية من النوافذ المنبثقة والتحويلات
            const originalOpen = window.open;
            const originalAlert = window.alert;
            const originalConfirm = window.confirm;
            const originalPrompt = window.prompt;
            
            window.open = function() {
                console.log('🛡️ تم منع نافذة منبثقة من البداية');
                showNotification('🛡️ تم منع إعلان منبثق', 'success');
                return null;
            };
            
            window.alert = () => {
                console.log('🛡️ تم منع alert مشبوه');
                return false;
            };
            
            window.confirm = () => {
                console.log('🛡️ تم منع confirm مشبوه'); 
                return false;
            };
            
            window.prompt = () => {
                console.log('🛡️ تم منع prompt مشبوه');
                return null;
            };
            
            // منع التحويلات المشبوهة
            const originalLocation = window.location;
            Object.defineProperty(window, 'location', {
                value: {
                    ...originalLocation,
                    href: originalLocation.href,
                    assign: () => {
                        console.log('🛡️ تم منع محاولة تحويل مشبوهة');
                        showNotification('🛡️ تم منع تحويل مشبوه', 'warning');
                    },
                    replace: () => {
                        console.log('🛡️ تم منع محاولة تحويل مشبوهة');
                        showNotification('🛡️ تم منع تحويل مشبوه', 'warning');
                    },
                    reload: originalLocation.reload.bind(originalLocation)
                },
                writable: false,
                configurable: false
            });

            loadMovies();
            setupSearch();
            setupAdBlocker();
            
            // تطبيق حماية دورية مكثفة جداً
            setInterval(() => {
                // إعادة تعريف النوافذ المنبثقة
                window.open = () => null;
                window.alert = () => false;
                window.confirm = () => false;
                window.prompt = () => null;
                
                // إزالة أي إعلانات جديدة
                document.querySelectorAll([
                    '[class*="ad"]', '[id*="ad"]', '[class*="popup"]', '[id*="popup"]',
                    '[class*="overlay"]', '[id*="overlay"]', '[class*="banner"]', '[id*="banner"]',
                    '[class*="modal"]', '[id*="modal"]', '.advertisement', '.popup', '.overlay'
                ].join(',')).forEach(el => {
                    if (!el.closest('.movie-card') && 
                        !el.closest('.modal-content') && 
                        !el.closest('.notification') &&
                        !el.closest('.navbar') &&
                        !el.closest('.video-container')) {
                        el.style.cssText = 'display:none!important;visibility:hidden!important;opacity:0!important';
                        el.remove();
                    }
                });
            }, 1000);
            
            console.log('🛡️ تم تفعيل الحماية المطلقة للموقع بنجاح');
        });

        // حماية شاملة لكامل الصفحة
        function blockAllAdsInPage() {
            // منع جميع أنواع النوافذ المنبثقة
            window.open = function() {
                showNotification('🛡️ تم منع نافذة منبثقة', 'success');
                return null;
            };

            // منع الإعلانات المتأخرة
            const killAds = () => {
                const adSelectors = [
                    '[class*="ad"]', '[id*="ad"]', '[class*="popup"]', '[id*="popup"]',
                    '[class*="banner"]', '[id*="banner"]', '[class*="overlay"]', '[id*="overlay"]',
                    '[class*="modal"]', '[id*="modal"]', '.advertisement', '.popup', '.overlay',
                    '.modal-ad', '.interstitial', '.ad-container', '.ads', '.popup-ad',
                    '.banner-ad', '.video-ad', '[data-ad]', '[data-popup]', '[data-banner]',
                    'div[style*="position: fixed"][style*="z-index"]',
                    'div[style*="position: absolute"][style*="z-index"]'
                ];

                adSelectors.forEach(selector => {
                    try {
                        const elements = document.querySelectorAll(selector);
                        elements.forEach(el => {
                            if (!el.closest('.movie-card') && 
                                !el.closest('.video-container') && 
                                !el.closest('.notification') &&
                                !el.closest('.modal-content')) {
                                el.style.display = 'none !important';
                                el.style.visibility = 'hidden !important';
                                el.style.opacity = '0 !important';
                                el.remove();
                            }
                        });
                    } catch (e) {
                        // تجاهل الأخطاء
                    }
                });
            };

            // تنفيذ فوري ومتكرر
            killAds();
            setInterval(killAds, 500);

            // منع الإعلانات الجديدة
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.tagName) {
                                // فحص العنصر الجديد
                                const isAd = node.className && (
                                    node.className.includes('ad') ||
                                    node.className.includes('popup') ||
                                    node.className.includes('banner') ||
                                    node.className.includes('overlay')
                                ) || node.id && (
                                    node.id.includes('ad') ||
                                    node.id.includes('popup') ||
                                    node.id.includes('banner')
                                );

                                if (isAd && !node.closest('.movie-card') && !node.closest('.video-container')) {
                                    node.remove();
                                    showNotification('🛡️ تم منع إعلان جديد', 'success');
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class', 'id', 'style']
            });
        }
        function toggleAdBlock() {
            adBlockEnabled = !adBlockEnabled;
            const btn = document.getElementById('adBlockBtn');
            
            if (adBlockEnabled) {
                btn.style.background = '#28a745';
                btn.innerHTML = '<i class="fas fa-shield-alt"></i> الحماية';
                showNotification('تم تفعيل الحماية الشاملة', 'success');
                protectVideoPlayer();
            } else {
                btn.style.background = '#dc3545';
                btn.innerHTML = '<i class="fas fa-shield-slash"></i> معطل';
                showNotification('تم إيقاف الحماية', 'info');
                // إعادة تحميل المشغل لإزالة الحماية
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && activeTab.textContent.includes('مشاهدة')) {
                    switchVideoTab('movie');
                }
            }
        }

        // حماية مطلقة ومكثفة ضد جميع أنواع الإعلانات والنوافذ المنبثقة
        function protectVideoPlayer() {
            if (!adBlockEnabled) return;

            // 1. منع جميع النوافذ المنبثقة بطريقة مطلقة ونهائية
            const blockAllPopups = () => {
                // إعادة تعريف جميع الطرق المؤدية للنوافذ المنبثقة
                window.open = () => {
                    console.log('🛡️ تم منع نافذة منبثقة');
                    showNotification('تم منع إعلان منبثق', 'success');
                    return null;
                };
                window.alert = () => false;
                window.confirm = () => false;
                window.prompt = () => null;
                window.focus = () => {};
                window.blur = () => {};
                
                // منع إعادة التوجيه
                const originalLocation = window.location;
                Object.defineProperty(window, 'location', {
                    value: {
                        ...originalLocation,
                        href: originalLocation.href,
                        assign: () => {},
                        replace: () => {},
                        reload: originalLocation.reload.bind(originalLocation)
                    },
                    writable: false
                });
            };

            // 2. حماية خاصة بالنقرات أثناء تشغيل الفيديو
            let isVideoPlaying = false;
            let playerProtectionActive = false;

            const activatePlayerProtection = () => {
                if (playerProtectionActive) return;
                playerProtectionActive = true;
                isVideoPlaying = true;

                console.log('🛡️ تم تفعيل الحماية المكثفة للمشغل');
                showNotification('🛡️ تم تفعيل الحماية المكثفة', 'info');

                // منع أي نقرة على المشغل إلا controls الفيديو
                const videoProtectionHandler = (e) => {
                    const target = e.target;
                    const isVideoArea = target.closest('.video-iframe') || 
                                      target.closest('.video-container') ||
                                      target.tagName === 'IFRAME';
                    
                    if (isVideoArea && isVideoPlaying) {
                        // السماح فقط بـ controls الأساسية للفيديو
                        const allowedElements = ['VIDEO', 'AUDIO'];
                        const allowedClasses = [
                            'vjs-', 'plyr-', 'video-js', 'controls', 'play', 'pause',
                            'volume', 'progress', 'mute', 'fullscreen', 'seek'
                        ];
                        
                        const isAllowedElement = allowedElements.includes(target.tagName);
                        const hasAllowedClass = allowedClasses.some(cls => 
                            target.className && target.className.toString().includes(cls)
                        );
                        
                        // إذا لم تكن من العناصر المسموحة
                        if (!isAllowedElement && !hasAllowedClass) {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            e.stopPropagation();
                            
                            blockAllPopups();
                            showNotification('🚫 تم منع نقرة إعلانية أثناء التشغيل', 'warning');
                            
                            // تطبيق حماية فورية
                            setTimeout(() => {
                                blockAllPopups();
                                removeAllAds();
                            }, 50);
                            
                            return false;
                        }
                    }
                };

                // إضافة الحماية لجميع أنواع الأحداث
                document.addEventListener('click', videoProtectionHandler, true);
                document.addEventListener('mousedown', videoProtectionHandler, true);
                document.addEventListener('mouseup', videoProtectionHandler, true);
                document.addEventListener('touchstart', videoProtectionHandler, true);
                document.addEventListener('touchend', videoProtectionHandler, true);
                
                // منع النقرات المزدوجة
                let lastClickTime = 0;
                document.addEventListener('dblclick', (e) => {
                    if (e.target.closest('.video-iframe') && isVideoPlaying) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        showNotification('تم منع نقرة مزدوجة مشبوهة', 'warning');
                        return false;
                    }
                }, true);
            };

            // 3. إزالة فورية ومكثفة لجميع أنواع الإعلانات
            const removeAllAds = () => {
                const adSelectors = [
                    // كلاسات ومعرفات الإعلانات
                    '[class*="ad"]', '[id*="ad"]', '[class*="popup"]', '[id*="popup"]',
                    '[class*="banner"]', '[id*="banner"]', '[class*="overlay"]', '[id*="overlay"]',
                    '[class*="modal"]', '[id*="modal"]', '[class*="promo"]', '[id*="promo"]',
                    
                    // كلاسات محددة للإعلانات
                    '.advertisement', '.popup', '.overlay', '.modal-ad', '.interstitial',
                    '.ad-container', '.ads', '.popup-ad', '.banner-ad', '.video-ad',
                    '.sponsored', '.promo-banner', '.ad-overlay', '.popup-overlay',
                    
                    // عناصر بخصائص البيانات
                    '[data-ad]', '[data-popup]', '[data-banner]', '[data-overlay]',
                    '[data-modal]', '[data-promo]', '[data-sponsored]',
                    
                    // عناصر بأنماط مشبوهة
                    'div[style*="position: fixed"]', 'div[style*="position:fixed"]',
                    'div[style*="z-index: 999"]', 'div[style*="z-index:999"]',
                    'div[style*="z-index: 9999"]', 'div[style*="z-index:9999"]',
                    
                    // إطارات مشبوهة
                    'iframe[src*="ad"]', 'iframe[src*="popup"]', 'iframe[src*="banner"]'
                ];

                adSelectors.forEach(selector => {
                    try {
                        document.querySelectorAll(selector).forEach(el => {
                            // تجاهل العناصر المشروعة
                            if (!el.closest('.movie-card') && 
                                !el.closest('.notification') && 
                                !el.closest('.modal-content') &&
                                !el.closest('.navbar') &&
                                !el.closest('.video-container')) {
                                
                                el.style.cssText = `
                                    display: none !important;
                                    visibility: hidden !important;
                                    opacity: 0 !important;
                                    pointer-events: none !important;
                                    position: absolute !important;
                                    left: -99999px !important;
                                    top: -99999px !important;
                                    width: 0 !important;
                                    height: 0 !important;
                                    z-index: -99999 !important;
                                `;
                                
                                // إزالة العنصر نهائياً
                                setTimeout(() => {
                                    if (el.parentNode) {
                                        el.parentNode.removeChild(el);
                                    }
                                }, 100);
                                
                                console.log('🛡️ تم حذف إعلان:', selector);
                            }
                        });
                    } catch (e) {
                        console.log('خطأ في إزالة الإعلان:', e);
                    }
                });
            };

            // 4. حماية iframe قوية جداً
            const protectIframes = () => {
                document.querySelectorAll('.video-iframe').forEach(iframe => {
                    // تطبيق sandbox قوي
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
                    iframe.style.pointerEvents = 'auto';
                    
                    // حماية iframe من الداخل
                    iframe.addEventListener('load', () => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const iframeWindow = iframe.contentWindow;
                            
                            // حقن JavaScript مكثف
                            const script = iframeDoc.createElement('script');
                            script.textContent = `
                                // منع جميع النوافذ المنبثقة داخل iframe
                                window.open = () => null;
                                window.alert = () => false;
                                window.confirm = () => false;
                                window.prompt = () => null;
                                window.focus = () => {};
                                window.blur = () => {};
                                
                                // منع إعادة التوجيه
                                const originalLocation = window.location;
                                window.location.assign = () => {};
                                window.location.replace = () => {};
                                
                                // منع النقرات المشبوهة
                                document.addEventListener('click', function(e) {
                                    const target = e.target;
                                    
                                    // منع النقر على الروابط
                                    if (target.tagName === 'A' || target.closest('a')) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        return false;
                                    }
                                    
                                    // منع النقر على عناصر الإعلانات
                                    const suspiciousClasses = ['ad', 'popup', 'banner', 'overlay', 'modal'];
                                    if (suspiciousClasses.some(cls => 
                                        target.className.includes(cls) || target.id.includes(cls))) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        return false;
                                    }
                                }, true);
                                
                                // منع اللمس المشبوه
                                document.addEventListener('touchstart', function(e) {
                                    if (e.target.tagName === 'A' || e.target.closest('a')) {
                                        e.preventDefault();
                                        return false;
                                    }
                                }, true);
                            `;
                            iframeDoc.head.appendChild(script);

                            // حقن CSS مكثف جداً
                            const style = iframeDoc.createElement('style');
                            style.textContent = `
                                /* إخفاء شامل لجميع أنواع الإعلانات */
                                [class*="ad"], [id*="ad"], [class*="popup"], [id*="popup"],
                                [class*="banner"], [id*="banner"], [class*="overlay"], [id*="overlay"],
                                [class*="modal"], [id*="modal"], [class*="promo"], [id*="promo"],
                                .advertisement, .popup, .overlay, .modal-ad, .interstitial,
                                .ad-container, .ads, .popup-ad, .banner-ad, .video-ad,
                                .sponsored, .promo-banner, .ad-overlay, .popup-overlay,
                                [data-ad], [data-popup], [data-banner], [data-overlay] {
                                    display: none !important;
                                    visibility: hidden !important;
                                    opacity: 0 !important;
                                    pointer-events: none !important;
                                    position: absolute !important;
                                    left: -99999px !important;
                                    top: -99999px !important;
                                    width: 0 !important;
                                    height: 0 !important;
                                    z-index: -99999 !important;
                                }
                                
                                /* منع الإعلانات المتحركة والتفاعلية */
                                * {
                                    animation: none !important;
                                    transition: none !important;
                                }
                                
                                a, [onclick], [onmousedown], [onmouseup] {
                                    pointer-events: none !important;
                                    cursor: default !important;
                                }
                                
                                /* حماية الفيديو */
                                video {
                                    pointer-events: auto !important;
                                    position: relative !important;
                                    z-index: 999 !important;
                                }
                            `;
                            iframeDoc.head.appendChild(style);

                            // تفعيل حماية المشغل عند بدء الفيديو
                            const videos = iframeDoc.querySelectorAll('video');
                            videos.forEach(video => {
                                video.addEventListener('play', activatePlayerProtection);
                                video.addEventListener('playing', activatePlayerProtection);
                            });

                            // مراقبة تشغيل الفيديو في iframe
                            setInterval(() => {
                                const videos = iframeDoc.querySelectorAll('video');
                                videos.forEach(video => {
                                    if (!video.paused && !video.ended) {
                                        activatePlayerProtection();
                                    }
                                });
                            }, 1000);

                        } catch (err) {
                            console.log('Cross-origin iframe - using external protection');
                            // حماية خارجية للـ iframe
                            iframe.style.border = 'none';
                            iframe.style.outline = 'none';
                            
                            // تفعيل الحماية عند النقر على iframe
                            iframe.addEventListener('click', activatePlayerProtection);
                        }
                    });
                });
            };

            // 5. مراقبة DOM مكثفة ومستمرة
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) {
                                // فحص فوري للعقد الجديدة
                                setTimeout(() => {
                                    removeAllAds();
                                    if (isVideoPlaying) {
                                        blockAllPopups();
                                    }
                                }, 10);
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class', 'id', 'style', 'src', 'onclick']
            });

            // 6. تطبيق الحماية بشكل دوري ومكثف
            setInterval(() => {
                if (adBlockEnabled) {
                    blockAllPopups();
                    removeAllAds();
                    
                    // التحقق من تشغيل الفيديو
                    const videos = document.querySelectorAll('video');
                    let videoIsPlaying = false;
                    videos.forEach(video => {
                        if (!video.paused && !video.ended) {
                            videoIsPlaying = true;
                            activatePlayerProtection();
                        }
                    });
                    
                    if (!videoIsPlaying) {
                        isVideoPlaying = false;
                        playerProtectionActive = false;
                    }
                }
            }, 500); // كل نصف ثانية

            // 7. تطبيق الحماية الأولية
            blockAllPopups();
            removeAllAds();
            protectIframes();

            console.log('🛡️ تم تفعيل الحماية المطلقة للمشغل');
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearchQuery = this.value.trim();
                    currentPage = 1;
                    if (currentSearchQuery) {
                        searchMovies();
                    } else {
                        loadMovies();
                    }
                }, 500);
            });
        }

        // Load movies from API
        async function loadMovies(page = 1) {
            const loadingEl = document.getElementById('loading');
            const moviesGrid = document.getElementById('moviesGrid');
            
            loadingEl.style.display = 'block';
            moviesGrid.innerHTML = '';

            try {
                let url;
                if (showingFavorites) {
                    displayFavorites();
                    return;
                }

                if (currentSearchQuery) {
                    url = `${BASE_URL}/search/movie?api_key=${API_KEY}&language=ar&query=${encodeURIComponent(currentSearchQuery)}&page=${page}`;
                } else if (currentGenre === 'all') {
                    url = `${BASE_URL}/movie/popular?api_key=${API_KEY}&language=ar&page=${page}`;
                } else {
                    const genreId = getGenreId(currentGenre);
                    url = `${BASE_URL}/discover/movie?api_key=${API_KEY}&language=ar&with_genres=${genreId}&page=${page}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    displayMovies(data.results);
                    updatePagination(data.page, data.total_pages);
                } else {
                    moviesGrid.innerHTML = '<div class="no-results">لم يتم العثور على أفلام</div>';
                }
            } catch (error) {
                console.error('Error loading movies:', error);
                moviesGrid.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>حدث خطأ في تحميل الأفلام</p>
                        <button class="retry-btn" onclick="loadMovies()">إعادة المحاولة</button>
                    </div>
                `;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Get genre ID for filtering
        function getGenreId(genre) {
            const genres = {
                'action': 28,
                'comedy': 35,
                'drama': 18,
                'horror': 27,
                'romance': 10749,
                'sci-fi': 878
            };
            return genres[genre] || '';
        }

        // Display movies in grid
        function displayMovies(movies) {
            const moviesGrid = document.getElementById('moviesGrid');
            moviesGrid.innerHTML = '';

            movies.forEach(movie => {
                const movieCard = createMovieCard(movie);
                moviesGrid.appendChild(movieCard);
            });
        }

        // Create movie card element
        function createMovieCard(movie) {
            const card = document.createElement('div');
            card.className = 'movie-card';
            card.onclick = () => openMovieModal(movie);

            const posterUrl = movie.poster_path 
                ? `${IMAGE_BASE_URL}${movie.poster_path}` 
                : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmaWxsPSIjNjY2IiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+لا توجد صورة</L3RleHQ+Cjwvc3ZnPgo=';

            const rating = movie.vote_average ? movie.vote_average.toFixed(1) : 'غير متوفر';
            const year = movie.release_date ? new Date(movie.release_date).getFullYear() : 'غير محدد';

            card.innerHTML = `
                <img class="movie-poster" src="${posterUrl}" alt="${movie.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmaWxsPSIjNjY2IiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+لا توجد صورة</L3RleHQ+Cjwvc3ZnPgo='">
                <div class="movie-info">
                    <h3 class="movie-title">${movie.title}</h3>
                    <div class="movie-year">${year}</div>
                    <div class="movie-rating">
                        <div class="stars">${generateStars(movie.vote_average)}</div>
                        <span>${rating}</span>
                    </div>
                    <p class="movie-overview">${movie.overview || 'لا يوجد وصف متاح'}</p>
                    <button class="watch-btn">
                        <i class="fas fa-play"></i> مشاهدة الفيلم
                    </button>
                </div>
            `;

            return card;
        }

        // Generate star rating
        function generateStars(rating) {
            const fullStars = Math.floor(rating / 2);
            const halfStar = rating % 2 >= 1 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;

            return '★'.repeat(fullStars) + (halfStar ? '☆' : '') + '☆'.repeat(emptyStars);
        }

        // Search movies
        function searchMovies() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                currentSearchQuery = query;
                currentPage = 1;
                showingFavorites = false;
                loadMovies();
            }
        }

        // Filter movies by genre
        function filterMovies(genre) {
            currentGenre = genre;
            currentPage = 1;
            showingFavorites = false;
            loadMovies();

            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Update pagination
        function updatePagination(currentPage, totalPages) {
            const paginationEl = document.getElementById('pagination');
            paginationEl.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-btn';
                prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                prevBtn.onclick = () => changePage(currentPage - 1);
                paginationEl.appendChild(prevBtn);
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => changePage(i);
                paginationEl.appendChild(pageBtn);
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-btn';
                nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                nextBtn.onclick = () => changePage(currentPage + 1);
                paginationEl.appendChild(nextBtn);
            }
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadMovies(page);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Open movie modal
        function openMovieModal(movie) {
            const modal = document.getElementById('movieModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalPoster = document.getElementById('modalPoster');
            const modalRating = document.getElementById('modalRating');
            const modalStars = document.getElementById('modalStars');
            const modalOverview = document.getElementById('modalOverview');

            modalTitle.textContent = movie.title;
            modalPoster.src = movie.poster_path 
                ? `${IMAGE_BASE_URL}${movie.poster_path}` 
                : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgdmlld0JveD0iMCAwIDMwMCA0NTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjI1IiBmaWxsPSIjNjY2IiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+لا توجد صورة</L3RleHQ+Cjwvc3ZnPgo=';
            modalRating.textContent = movie.vote_average ? movie.vote_average.toFixed(1) : 'غير متوفر';
            modalStars.innerHTML = generateStars(movie.vote_average);
            modalOverview.textContent = movie.overview || 'لا يوجد وصف متاح لهذا الفيلم.';

            // Store movie data for video loading
            window.currentMovie = movie;

            // Generate streaming sources
            generateStreamingSources(movie);

            // Reset tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.tab-btn').classList.add('active');

            // Reset video container
            resetVideoContainer();

            modal.style.display = 'block';
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('movieModal');
            modal.style.display = 'none';
            
            // Stop any playing video
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.innerHTML = `
                <div class="video-error">
                    <i class="fas fa-play-circle" style="font-size: 4rem; margin-bottom: 20px;"></i>
                    <h3>اختر نوع المحتوى من الأعلى</h3>
                </div>
            `;
        }

        // Switch video tabs with enhanced protection
        function switchVideoTab(tab) {
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (!btn.id || btn.id !== 'adBlockBtn') {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');

            const videoContainer = document.getElementById('videoContainer');
            const alternativeSources = document.getElementById('alternativeSources');

            if (tab === 'trailer') {
                loadTrailer();
                alternativeSources.style.display = 'none';
            } else if (tab === 'movie') {
                loadDirectStreamingSources();
                alternativeSources.style.display = 'block';
                
                // تطبيق الحماية المكثفة والمتعددة الطبقات
                setTimeout(() => {
                    protectVideoPlayer();
                    
                    // حماية إضافية خاصة بتبويب المشاهدة
                    const iframes = videoContainer.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        // منع جميع النوافذ المنبثقة فوراً
                        window.open = () => {
                            console.log('🛡️ تم منع نافذة منبثقة في تبويب المشاهدة');
                            showNotification('تم منع إعلان في المشغل', 'success');
                            return null;
                        };
                        
                        // حماية النقرات على iframe
                        iframe.addEventListener('click', (e) => {
                            console.log('🛡️ نقرة على مشغل الفيديو');
                            
                            // تطبيق حماية فورية
                            window.open = () => null;
                            window.alert = () => false;
                            window.confirm = () => false;
                            
                            // إزالة أي عناصر إعلانية جديدة
                            setTimeout(() => {
                                document.querySelectorAll('[class*="popup"], [class*="ad"], [class*="overlay"], [class*="modal"]').forEach(el => {
                                    if (!el.closest('.movie-card') && 
                                        !el.closest('.modal-content') && 
                                        !el.closest('.notification')) {
                                        el.style.display = 'none';
                                        el.remove();
                                    }
                                });
                            }, 50);
                        });
                        
                        // حماية اللمس للهواتف
                        iframe.addEventListener('touchstart', (e) => {
                            window.open = () => null;
                            setTimeout(() => {
                                document.querySelectorAll('[class*="popup"], [class*="ad"]').forEach(el => {
                                    if (!el.closest('.movie-card') && !el.closest('.modal-content')) {
                                        el.remove();
                                    }
                                });
                            }, 100);
                        });
                    });
                }, 500);
                
                // حماية مستمرة أثناء تشغيل الفيديو
                const protectionInterval = setInterval(() => {
                    // منع النوافذ المنبثقة
                    window.open = () => null;
                    
                    // إزالة أي إعلانات جديدة
                    document.querySelectorAll('[class*="ad"], [class*="popup"], [class*="overlay"]').forEach(el => {
                        if (!el.closest('.movie-card') && 
                            !el.closest('.modal-content') && 
                            !el.closest('.notification')) {
                            el.style.display = 'none';
                            el.remove();
                        }
                    });
                }, 1000);
                
                // إيقاف الحماية المستمرة عند إغلاق المودال
                const modal = document.getElementById('movieModal');
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'style' && 
                            modal.style.display === 'none') {
                            clearInterval(protectionInterval);
                            observer.disconnect();
                        }
                    });
                });
                observer.observe(modal, { attributes: true });
                
            } else if (tab === 'sources') {
                showAlternativeSources();
                alternativeSources.style.display = 'none';
            }
        }

        // Load trailer
        async function loadTrailer() {
            const videoContainer = document.getElementById('videoContainer');
            const movie = window.currentMovie;

            videoContainer.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const response = await fetch(`${BASE_URL}/movie/${movie.id}/videos?api_key=${API_KEY}&language=en`);
                const data = await response.json();
                
                const trailer = data.results.find(video => 
                    video.type === 'Trailer' && video.site === 'YouTube'
                ) || data.results[0];

                if (trailer) {
                    videoContainer.innerHTML = `
                        <iframe class="video-iframe" 
                                src="https://www.youtube.com/embed/${trailer.key}?autoplay=1" 
                                allowfullscreen>
                        </iframe>
                    `;
                } else {
                    videoContainer.innerHTML = `
                        <div class="video-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>لا يوجد تريلر متاح</h3>
                            <p>جرب المصادر الأخرى</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading trailer:', error);
                videoContainer.innerHTML = `
                    <div class="video-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>خطأ في تحميل التريلر</h3>
                        <p>تحقق من الاتصال بالإنترنت</p>
                    </div>
                `;
            }
        }

        // Load direct streaming sources
        function loadDirectStreamingSources() {
            const videoContainer = document.getElementById('videoContainer');
            const sourcesGrid = document.getElementById('sourcesGrid');
            const movie = window.currentMovie;

            console.log('🛡️ تحميل مصادر المشاهدة مع الحماية المكثفة...');

            // تطبيق حماية فورية قبل تحميل المصادر
            window.open = () => {
                showNotification('🛡️ تم منع نافذة منبثقة من المشغل', 'success');
                return null;
            };

            // Clean sources with minimal ads
            const cleanSources = [
                { 
                    name: 'مصدر محمي 1', 
                    url: `https://vidsrc.cc/v2/embed/movie/${movie.id}`,
                    clean: true
                },
                { 
                    name: 'مصدر محمي 2', 
                    url: `https://www.2embed.cc/embed/${movie.id}`,
                    clean: true
                }
            ];

            // Regular sources (working but with ads)
            const regularSources = [
                { 
                    name: 'مصدر محمي 3', 
                    url: `https://vidsrc.to/embed/movie/${movie.id}`,
                    clean: false
                },
                { 
                    name: 'مصدر محمي 4', 
                    url: `https://www.2embed.to/embed/tmdb/movie?id=${movie.id}`,
                    clean: false
                },
                { 
                    name: 'مصدر 5', 
                    url: `https://multiembed.mov/directstream.php?video_id=${movie.id}&tmdb=1`,
                    clean: false
                }
            ];

            // Try clean source first
            const firstSource = cleanSources[0];
            
            videoContainer.innerHTML = `
                <div style="position: relative;">
                    <iframe class="video-iframe" 
                            src="${firstSource.url}" 
                            allowfullscreen
                            allow="autoplay; fullscreen; picture-in-picture"
                            referrerpolicy="no-referrer">
                    </iframe>
                    ${firstSource.clean ? '<div class="clean-badge">خالي من الإعلانات</div>' : '<div class="ad-block-notice">قد يحتوي على إعلانات</div>'}
                </div>
            `;

            // Generate all sources
            const allSources = [...cleanSources, ...regularSources];
            
            sourcesGrid.innerHTML = '';
            allSources.forEach((source, index) => {
                const sourceBtn = document.createElement('button');
                sourceBtn.className = `source-btn ${source.clean ? 'clean-source' : ''}`;
                sourceBtn.innerHTML = `
                    ${source.name} 
                    ${source.clean ? '<i class="fas fa-shield-alt" style="color: #28a745; margin-left: 5px;"></i>' : '<i class="fas fa-exclamation-triangle" style="color: #ffc107; margin-left: 5px;"></i>'}
                `;
                sourceBtn.onclick = () => {
                    videoContainer.innerHTML = `
                        <div style="position: relative;">
                            <iframe class="video-iframe" 
                                    src="${source.url}" 
                                    allowfullscreen
                                    sandbox="allow-scripts allow-same-origin"
                                    allow="autoplay; fullscreen; picture-in-picture"
                                    referrerpolicy="no-referrer">
                            </iframe>
                            ${source.clean ? '<div class="clean-badge">خالي من الإعلانات</div>' : '<div class="ad-block-notice">محمي من الإعلانات</div>'}
                        </div>
                    `;
                    showNotification(`تم تغيير المصدر إلى ${source.name}`, 'success');
                    
                    // تطبيق الحماية فوراً بعد تحميل المصدر
                    setTimeout(() => {
                        protectVideoPlayer();
                        blockAllAdsInPage();
                    }, 500);
                };
                sourcesGrid.appendChild(sourceBtn);
            });

            // Add ad block instructions
            const instructionsDiv = document.createElement('div');
            instructionsDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: rgba(229, 9, 20, 0.1); border-radius: 5px; color: #e50914; font-size: 12px;';
            instructionsDiv.innerHTML = `
                <i class="fas fa-info-circle"></i> 
                <strong>نصائح مهمة للمشاهدة:</strong><br>
                • استخدم المصادر النظيفة (🛡️) للحصول على تجربة خالية من الإعلانات<br>
                • في حالة ظهور نوافذ منبثقة، أغلقها فوراً ولا تنقر عليها<br>
                • إذا لم يعمل مصدر، جرب المصدر التالي<br>
                • تم تفعيل حماية تلقائية من النوافذ المنبثقة<br>
                • <strong>لا تدخل معلومات شخصية في أي نافذة منبثقة</strong>
            `;
            
            const alternativeSources = document.getElementById('alternativeSources');
            if (alternativeSources.querySelector('.ad-block-instructions')) {
                alternativeSources.querySelector('.ad-block-instructions').remove();
            }
            instructionsDiv.className = 'ad-block-instructions';
            alternativeSources.appendChild(instructionsDiv);
        }

        // Show alternative sources
        function showAlternativeSources() {
            const videoContainer = document.getElementById('videoContainer');
            const movie = window.currentMovie;
            
            const sources = [
                {
                    name: 'فيديو بلس',
                    url: `https://vidplus.org/search.html?q=${encodeURIComponent(movie.title)}`,
                    description: 'مشاهدة مجانية بجودة عالية'
                },
                {
                    name: 'أكوام',
                    url: `https://akwam.co/search?q=${encodeURIComponent(movie.title)}`,
                    description: 'موقع أفلام مجاني'
                },
                {
                    name: 'سيما كلوب',
                    url: `https://cimaclub.cam/search?q=${encodeURIComponent(movie.title)}`,
                    description: 'مشاهدة أونلاين'
                },
                {
                    name: 'فشار',
                    url: `https://faselhd.pro/search?q=${encodeURIComponent(movie.title)}`,
                    description: 'أحدث الأفلام'
                }
            ];

            let sourcesHTML = '';
            sources.forEach(source => {
                sourcesHTML += `
                    <div class="source-card">
                        <h4>${source.name}</h4>
                        <p class="source-description">${source.description}</p>
                        <a href="${source.url}" target="_blank" class="source-link">
                            <i class="fas fa-external-link-alt"></i> زيارة الموقع
                        </a>
                    </div>
                `;
            });

            videoContainer.innerHTML = `
                <div class="video-error">
                    <i class="fas fa-globe"></i>
                    <h3>مصادر خارجية للمشاهدة</h3>
                    <p>اختر أحد المواقع أدناه</p>
                </div>
            `;
        }

        // Generate streaming sources
        function generateStreamingSources(movie) {
            const streamingSources = document.getElementById('streamingSources');
            
            const sources = [
                {
                    name: 'Tubi TV',
                    url: `https://tubitv.com/search/${encodeURIComponent(movie.title)}`,
                    description: 'مشاهدة مجانية مع إعلانات',
                    icon: 'fas fa-tv'
                },
                {
                    name: 'Crackle',
                    url: `https://www.crackle.com/search?query=${encodeURIComponent(movie.title)}`,
                    description: 'أفلام مجانية من Sony',
                    icon: 'fas fa-play'
                },
                {
                    name: 'YouTube Movies',
                    url: `https://www.youtube.com/results?search_query=${encodeURIComponent(movie.title + ' full movie')}`,
                    description: 'قد تجد الفيلم مجاناً',
                    icon: 'fab fa-youtube'
                },
                {
                    name: 'Internet Archive',
                    url: `https://archive.org/search.php?query=${encodeURIComponent(movie.title)}`,
                    description: 'أرشيف مجاني للأفلام',
                    icon: 'fas fa-archive'
                }
            ];

            let sourcesHTML = '';
            sources.forEach(source => {
                sourcesHTML += `
                    <div class="source-card">
                        <h4><i class="${source.icon}"></i> ${source.name}</h4>
                        <p class="source-description">${source.description}</p>
                        <a href="${source.url}" target="_blank" class="source-link">
                            <i class="fas fa-external-link-alt"></i> زيارة الموقع
                        </a>
                    </div>
                `;
            });

            streamingSources.innerHTML = sourcesHTML;
        }

        // Reset video container
        function resetVideoContainer() {
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.innerHTML = `
                <div class="video-error">
                    <i class="fas fa-play-circle" style="font-size: 4rem; margin-bottom: 20px;"></i>
                    <h3>اختر نوع المحتوى من الأعلى</h3>
                </div>
            `;
        }

        // Favorites functionality
        function toggleFavorites() {
            const favBtn = document.querySelector('.favorites-btn');
            showingFavorites = !showingFavorites;
            
            if (showingFavorites) {
                favBtn.classList.add('active');
                displayFavorites();
            } else {
                favBtn.classList.remove('active');
                loadMovies();
            }
        }

        function addToFavorites(movie) {
            let favorites = JSON.parse(localStorage.getItem('movieFavorites') || '[]');
            
            if (!favorites.find(fav => fav.id === movie.id)) {
                favorites.push(movie);
                localStorage.setItem('movieFavorites', JSON.stringify(favorites));
                showNotification('تم إضافة الفيلم للمفضلة', 'success');
            } else {
                showNotification('الفيلم موجود بالفعل في المفضلة', 'info');
            }
        }

        function removeFromFavorites(movieId) {
            let favorites = JSON.parse(localStorage.getItem('movieFavorites') || '[]');
            favorites = favorites.filter(fav => fav.id !== movieId);
            localStorage.setItem('movieFavorites', JSON.stringify(favorites));
            showNotification('تم حذف الفيلم من المفضلة', 'success');
            
            if (showingFavorites) {
                displayFavorites();
            }
        }

        function displayFavorites() {
            const favorites = JSON.parse(localStorage.getItem('movieFavorites') || '[]');
            const moviesGrid = document.getElementById('moviesGrid');
            const pagination = document.getElementById('pagination');
            
            if (favorites.length === 0) {
                moviesGrid.innerHTML = '<div class="no-results">لا توجد أفلام في المفضلة</div>';
                pagination.innerHTML = '';
                return;
            }
            
            displayMovies(favorites);
            pagination.innerHTML = '';
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Handle escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Advanced Ad Blocker
        function blockAds() {
            // Block common ad domains
            const adDomains = [
                'doubleclick.net',
                'googleadservices.com',
                'googlesyndication.com',
                'amazon-adsystem.com',
                'facebook.com/tr',
                'google-analytics.com',
                'googletagmanager.com'
            ];

            // Override fetch to block ad requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                if (typeof url === 'string') {
                    for (const domain of adDomains) {
                        if (url.includes(domain)) {
                            console.log('Blocked ad request:', url);
                            return Promise.reject('Ad blocked');
                        }
                    }
                }
                return originalFetch.apply(this, args);
            };

            // Block ad elements
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            // Block common ad selectors
                            const adSelectors = [
                                '[id*="ad"]',
                                '[class*="ad"]',
                                '[id*="banner"]',
                                '[class*="banner"]',
                                'iframe[src*="ads"]',
                                'div[style*="position: fixed"]'
                            ];
                            
                            adSelectors.forEach(selector => {
                                const adElements = node.querySelectorAll ? node.querySelectorAll(selector) : [];
                                adElements.forEach(el => {
                                    if (el && !el.closest('.movie-card') && !el.closest('.modal')) {
                                        el.style.display = 'none';
                                        console.log('Blocked ad element:', el);
                                    }
                                });
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });
        }

        // Initialize ad blocker when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(blockAds, 1000);
            setupiOSCompatibility();
            protectVideoPlayer(); // تفعيل الحماية الشاملة
            blockAllAdsInPage(); // تفعيل حماية الصفحة الكاملة
            
            // حماية إضافية كل 3 ثوان
            setInterval(() => {
                if (adBlockEnabled) {
                    protectVideoPlayer();
                    blockAllAdsInPage();
                }
            }, 3000);
        });

        // Setup iOS and fullscreen compatibility
        function setupiOSCompatibility() {
            // منع التكبير المزدوج في iPhone
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // حماية ضد الإعلانات عند fullscreen
            document.addEventListener('fullscreenchange', function() {
                if (adBlockEnabled) {
                    setTimeout(() => {
                        blockAds();
                        const ads = document.querySelectorAll('*[class*="ad"], *[id*="ad"], *[class*="popup"]');
                        ads.forEach(ad => ad.style.display = 'none');
                    }, 100);
                }
            });

            // حماية ضد الإعلانات عند تغيير orientation في iPhone
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    if (adBlockEnabled) {
                        blockAds();
                        const ads = document.querySelectorAll('*[class*="ad"], *[id*="ad"], *[class*="popup"]');
                        ads.forEach(ad => ad.style.display = 'none');
                    }
                }, 500);
            });

            // منع النقر المزدوج المؤدي للإعلانات
            let clickCount = 0;
            document.addEventListener('click', function(e) {
                const target = e.target;
                const isVideoPlayer = target.closest('.video-iframe') || target.closest('.video-container');
                
                if (isVideoPlayer) {
                    clickCount++;
                    
                    // السماح بنقرة واحدة فقط كل ثانيتين
                    if (clickCount > 1) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        showNotification('🛡️ تم منع نقرة إضافية', 'warning');
                        return false;
                    }
                    
                    // إعادة تعيين العداد بعد ثانيتين
                    setTimeout(() => {
                        clickCount = 0;
                    }, 2000);
                    
                    // تطبيق حماية فورية بعد النقر
                    setTimeout(() => {
                        blockAllAdsInPage();
                        protectVideoPlayer();
                    }, 100);
                }
            }, true);
        }
    </script>
</body>
</html>
